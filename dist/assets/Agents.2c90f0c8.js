import{_ as A}from"./AgentTasksList.3c2e6ebb.js";import{_ as x}from"./TagViewer.a3da6a20.js";import{_ as d}from"./DateTimeDisplay.c35d52fb.js";import{h as b}from"./moment.9709ab41.js";import{e as y,b3 as C,b4 as E,b5 as F,n as _,p as g,b as l,c as r,g as h,h as i,a1 as p,l as m,f as u,i as c}from"./index.85262dd3.js";import{_ as L}from"./VDataTable.125536b6.js";import{_ as I}from"./VTooltip.0c849a74.js";import{_ as T}from"./ExpansionPanelFilter.8ec031fa.js";import{_ as $}from"./AdvancedTable.8f5cf108.js";import{_ as w}from"./ListPageTop.2a204a11.js";import{g as P}from"./tag-api.d2d18349.js";import{_ as f}from"./VSwitch.8a27782c.js";import{_ as D,a as v,b as M,c as k}from"./VTabItem.35a0348a.js";import"./TooltipButton.6f10f736.js";import"./index.c62fa657.js";import"./ansi_up.de92b8a0.js";import"./download-stager.cac59e06.js";import"./VPagination.873af1be.js";import"./ExpansionPanelSearch.252e89f2.js";import"./VExpansionPanelHeader.1232ca65.js";import"./VSelect.8543571f.js";import"./VExpansionPanels.d99facd5.js";import"./VBreadcrumbs.32f4f2d0.js";const K={name:"AgentsTable",components:{DateTimeDisplay:d,TagViewer:x},props:{input:{type:Array,default:()=>[]},selectedTags:{type:Array,default:()=>[]},hideStaleAgents:{type:Boolean,required:!0},hideArchivedAgents:{type:Boolean,required:!0}},data(){return{loading:!1,headersFull:[{text:"Name",value:"name",defaultHeader:!0,alwaysShow:!0,order:1},{text:"Last Seen",value:"lastseen_time",defaultHeader:!0,alwaysShow:!0,order:2},{text:"First Seen",value:"checkin_time",defaultHeader:!0,alwaysShow:!0,order:3},{text:"Listener",value:"listener",order:4},{text:"Hostname",value:"hostname",defaultHeader:!0,order:5},{text:"Process",value:"process_name",defaultHeader:!0,order:6},{text:"Process ID",value:"process_id",order:7},{text:"Architecture",value:"architecture",order:8},{text:"Language",value:"language",defaultHeader:!0,order:9},{text:"Language Version",value:"language_version",order:10},{text:"Username",value:"username",defaultHeader:!0,order:11},{text:"Working Hours",value:"working_hours",order:12},{text:"External IP",value:"external_ip",order:13},{text:"Internal IP",value:"internal_ip",defaultHeader:!0,order:14},{text:"Delay",value:"delay",order:15},{text:"Jitter",value:"jitter",order:16},{text:"Tags",value:"tags",order:17},{text:"Actions",value:"actions",defaultHeader:!0,alwaysShow:!0,order:18}],selectedHeadersTemp:[],selected:[],showHeaderMenu:!1,moment:b}},computed:{...y({agents:s=>s.agent.agents,agentsStatus:s=>s.agent.status,selectedHeadersState:s=>s.application.agentHeaders}),selectedAll:{set(s){this.selectedHeadersTemp=[...this.staticHeaders],s&&this.headersFull.forEach(e=>{this.selectedHeadersTemp.push(e)})},get(){return this.selectedHeadersTemp.length===this.count}},headers(){return this.headersFull.filter(s=>this.selectedHeaders.findIndex(e=>e.text===s.text)>-1).sort((s,e)=>s.order-e.order)},selectableHeaders(){return this.headersFull.filter(s=>!s.alwaysShow)},staticHeaders(){return this.headersFull.filter(s=>s.alwaysShow)},sortedAgents(){let s=this.agents.slice();return s.sort((e,t)=>-e.lastseen_time.localeCompare(t.lastseen_time)),this.hideStaleAgents&&(s=s.filter(e=>!e.stale)),this.hideArchivedAgents&&(s=s.filter(e=>!e.archived)),this.selectedTags.length===0||(s=s.filter(e=>e.tags.map(a=>`${a.name}:${a.value}`).some(a=>this.selectedTags.includes(a)))),s},selectedHeaders:{set(s){this.$store.dispatch("application/agentHeaders",s)},get(){return this.selectedHeadersState}}},watch:{selectedTags(){this.getAgents()},selected(s){this.$emit("input",s)}},async mounted(){this.getAgents(),this.selectedHeaders.length===0&&(this.selectedHeaders=this.headersFull.filter(s=>s.defaultHeader===!0)),this.selectedHeadersTemp=[...this.selectedHeaders]},methods:{deleteTag(s,e){C(s.session_id,e.id).then(()=>{s.tags=s.tags.filter(t=>t.id!==e.id),this.$emit("refresh-tags")}).catch(t=>this.$snack.error(`Error: ${t}`))},updateTag(s,e){E(s.session_id,e).then(t=>{const a=s.tags.findIndex(n=>n.id===t.id);s.tags.splice(a,1,t),this.$emit("refresh-tags"),this.$snack.success("Tag updated")}).catch(t=>this.$snack.error(`Error: ${t}`))},addTag(s,e){F(s.session_id,e).then(t=>{s.tags.push(t),this.$emit("refresh-tags")}).catch(t=>this.$snack.error(`Error: ${t}`))},submitHeaderForm(){this.selectedHeaders=[...this.selectedHeadersTemp],this.showHeaderMenu=!1},getAgents(){this.$store.dispatch("agent/getAgents")},async killAgent(s){this.$emit("killAgent",s)},popout(s){window.open(`${window.location.href}/${s.name}?hideSideBar=true`,"popup","width=600,height=600")},truncateMessage(s){return s?s.length>30?`${s.substr(0,30)}...`:s:""},rowClass(s){return s.stale?"warning-row":""}}};var q=function(){var e=this,t=e._self._c;return t("div",[t("div",{staticClass:"ml-3 mr-3 align-center",staticStyle:{display:"flex","flex-direction":"row-reverse"}},[t("div",{staticStyle:{height:"40px"}}),t(g,{attrs:{"offset-y":"","close-on-content-click":!1},scopedSlots:e._u([{key:"activator",fn:function({on:a,attrs:n}){return[t(l,e._g(e._b({attrs:{text:"",icon:"","x-small":""}},"v-btn",n,!1),a),[t(r,[e._v("mdi-format-columns")])],1)]}}]),model:{value:e.showHeaderMenu,callback:function(a){e.showHeaderMenu=a},expression:"showHeaderMenu"}},[t(h,{staticStyle:{"overflow-y":"auto"},attrs:{"max-height":"400px"}},[t(i,[t(p,{attrs:{label:"Select All"},model:{value:e.selectedAll,callback:function(a){e.selectedAll=a},expression:"selectedAll"}})],1),t(m,{staticClass:"pb-4"}),e._l(e.selectableHeaders,function(a,n){return t(i,{key:n},[t(p,{attrs:{label:a.text,value:a},model:{value:e.selectedHeadersTemp,callback:function(o){e.selectedHeadersTemp=o},expression:"selectedHeadersTemp"}})],1)})],2),t(u,{staticClass:"pt-4"},[t(l,{staticClass:"mb-4",attrs:{text:""},on:{click:function(a){e.showHeaderMenu=!1}}},[e._v(" Cancel ")]),t(l,{staticClass:"ml-4 mb-4",attrs:{text:""},on:{click:e.submitHeaderForm}},[e._v(" Save ")])],1)],1)],1),t(L,{attrs:{loading:e.agentsStatus==="loading","item-class":e.rowClass,headers:e.headers,items:e.sortedAgents,"footer-props":{itemsPerPageOptions:[5,10,15,20,50,100]},"items-per-page":15,"item-key":"session_id",dense:"","show-select":""},scopedSlots:e._u([{key:"item.name",fn:function({item:a}){return[t(I,{attrs:{top:""},scopedSlots:e._u([{key:"activator",fn:function({on:n}){return[a.high_integrity?t(r,e._g({attrs:{small:""}},n),[e._v(" fa-user-cog ")]):e._e()]}}],null,!0)},[t("span",[e._v("Elevated Process")])]),t("router-link",{staticStyle:{color:"inherit"},attrs:{to:{name:"agentEdit",params:{id:a.session_id}}}},[e._v(" "+e._s(a.name)+" ")])]}},{key:"item.lastseen_time",fn:function({item:a}){return[t(d,{attrs:{timestamp:a.lastseen_time}})]}},{key:"item.checkin_time",fn:function({item:a}){return[t(d,{attrs:{timestamp:a.checkin_time}})]}},{key:"item.listener",fn:function({item:a}){return[t("router-link",{staticStyle:{color:"inherit"},attrs:{to:{name:"listenerEdit",params:{id:a.listener}}}},[e._v(" "+e._s(a.listener)+" ")])]}},{key:"item.process_name",fn:function({item:a}){return[t("span",[e._v(e._s(e.truncateMessage(a.process_name)))])]}},{key:"item.tags",fn:function({item:a}){return[t(x,{attrs:{tags:a.tags},on:{"update-tag":function(n){return e.updateTag(a,...arguments)},"delete-tag":function(n){return e.deleteTag(a,...arguments)},"new-tag":function(n){return e.addTag(a,...arguments)}}})]}},{key:"item.actions",fn:function({item:a}){return[t(g,{attrs:{"offset-y":""},scopedSlots:e._u([{key:"activator",fn:function({on:n,attrs:o}){return[t(l,e._g(e._b({attrs:{text:"",icon:"","x-small":""}},"v-btn",o,!1),n),[t(r,[e._v("fa-ellipsis-v")])],1)]}}],null,!0)},[t(h,{staticClass:"ml-2 mr-2"},[t(i,{key:"view",attrs:{link:""}},[t("router-link",{staticClass:"text-decoration-none",staticStyle:{color:"inherit"},attrs:{to:{name:"agentEdit",params:{id:a.session_id}}}},[t(c,[t(r,[e._v("fa-binoculars")]),e._v(" View ")],1)],1)],1),t(i,{key:"popout",attrs:{link:""},on:{click:function(n){return e.popout(a)}}},[t(c,[t(r,[e._v(" fa-external-link-alt ")]),e._v(" Popout ")],1)],1),t(m,{staticClass:"pb-4"}),t(i,{key:"delete",attrs:{link:""},on:{click:function(n){return e.killAgent(a)}}},[t(c,[t(r,[e._v("fa-trash-alt")]),e._v(" Kill ")],1)],1)],1)],1)]}}]),model:{value:e.selected,callback:function(a){e.selected=a},expression:"selected"}})],1)},B=[],V=_(K,q,B,!1,null,"35a78316",null,null);const H=V.exports;const R={name:"AgentsList",components:{AdvancedTable:$,ExpansionPanelFilter:T,AgentsTable:H,ListPageTop:w},props:{active:{type:Boolean,default:!1}},data(){return{breads:[{text:"Agents",disabled:!0,href:"/agents"},{text:"List",disabled:!0,href:"/agents?tab=list-view"}],selected:[],selectedTags:[],tags:[],moment:b}},computed:{...y({agents:s=>s.agent.agents,hideStaleAgents:s=>s.application.hideStaleAgents,hideArchivedAgents:s=>s.application.hideArchivedAgents}),sortedAgents(){let s=this.agents.slice();return s.sort((e,t)=>-e.lastseen_time.localeCompare(t.lastseen_time)),this.hideStaleAgents&&(s=s.filter(e=>!e.stale)),this.hideArchivedAgents&&(s=s.filter(e=>!e.archived)),this.selectedTags.length===0||(s=s.filter(e=>e.tags.map(a=>`${a.name}:${a.value}`).some(a=>this.selectedTags.includes(a)))),s},showDelete(){return this.selected.length>0},hideStaleAgentsCheckbox:{set(s){this.$store.dispatch("application/hideStaleAgents",s)},get(){return this.hideStaleAgents}},hideArchivedAgentsCheckbox:{set(s){this.$store.dispatch("application/hideArchivedAgents",s)},get(){return this.hideArchivedAgents}}},async mounted(){this.getTags()},methods:{async getTags(){const s=await P({page:1,limit:-1,sources:"agent"}),e=[];s.records.forEach(t=>{e.find(n=>n.name===t.name&&n.value===t.value)||e.push(t)}),this.tags=e},async killAgents(){await this.$root.$confirm("Kill Agent",`Do you want to kill ${this.selected.length} agents?`,{color:"red"})&&(this.selected.forEach(s=>{this.$store.dispatch("agent/killAgent",{sessionId:s.session_id})}),this.$snack.success(`${this.selected.length} agents tasked to run TASK_EXIT.`),this.selected=[])},getAgents(){this.$refs.agentsTable.getAgents()},async killAgent(s){await this.$root.$confirm("Kill Agent",`Do you want to kill agent ${s.name}?`,{color:"red"})&&(this.$store.dispatch("agent/killAgent",{sessionId:s.session_id}),this.$snack.success(`Agent ${s.name} tasked to run TASK_EXIT.`))}}};var X=function(){var e=this,t=e._self._c;return t("div",[e.active?t(w,{attrs:{breads:e.breads,"show-create":!1,"show-refresh":!0,"show-delete":e.showDelete,"delete-text":"Kill"},on:{delete:e.killAgents,refresh:e.getAgents}}):e._e(),t($,{scopedSlots:e._u([{key:"filters",fn:function(){return[t(f,{attrs:{label:"Hide Stale Agents"},model:{value:e.hideStaleAgentsCheckbox,callback:function(a){e.hideStaleAgentsCheckbox=a},expression:"hideStaleAgentsCheckbox"}}),t(f,{staticClass:"pl-4",attrs:{label:"Hide Archived Agents"},model:{value:e.hideArchivedAgentsCheckbox,callback:function(a){e.hideArchivedAgentsCheckbox=a},expression:"hideArchivedAgentsCheckbox"}}),t(T,{attrs:{title:"Tags",label:"label","item-key":"id","item-value":"label",items:e.tags,"empty-default":!0},model:{value:e.selectedTags,callback:function(a){e.selectedTags=a},expression:"selectedTags"}})]},proxy:!0},{key:"table",fn:function(){return[t(H,{ref:"agentsTable",attrs:{"hide-stale-agents":e.hideStaleAgentsCheckbox,"hide-archived-agents":e.hideArchivedAgentsCheckbox,"selected-tags":e.selectedTags},on:{"refresh-tags":e.getTags},model:{value:e.selected,callback:function(a){e.selected=a},expression:"selected"}})]},proxy:!0}])})],1)},j=[],z=_(R,X,j,!1,null,"42b94296",null,null);const S=z.exports;const J={name:"Agents",components:{AgentsList:S,AgentTasksList:A},data(){return{}},computed:{tab:{set(s){this.$router.replace({query:{...this.$route.query,tab:s}})},get(){return this.$route.query.tab||"list-view"}}}};var N=function(){var e=this,t=e._self._c;return t("div",[t("portal",{attrs:{to:"app-bar-extension"}},[t("div",{staticStyle:{display:"flex","flex-direction":"row",width:"100%"}},[t(D,{attrs:{"align-with-title":""},model:{value:e.tab,callback:function(a){e.tab=a},expression:"tab"}},[t(v,{key:"list-view",attrs:{href:"#list-view"}},[e._v(" List "),t(r,{staticClass:"ml-1",attrs:{"x-small":""}},[e._v(" fa-list ")])],1),t(v,{key:"tasks",attrs:{href:"#tasks"}},[e._v(" Tasks "),t(r,{staticClass:"ml-1",attrs:{"x-small":""}},[e._v(" fa-sticky-note ")])],1)],1)],1)]),t(M,{model:{value:e.tab,callback:function(a){e.tab=a},expression:"tab"}},[t(k,{key:"list-view",attrs:{value:"list-view",transition:!1,"reverse-transition":!1}},[t(u,{attrs:{flat:""}},[t(S,{attrs:{active:e.tab==="list-view"}})],1)],1),t(k,{key:"tasks",attrs:{value:"tasks",transition:!1,"reverse-transition":!1}},[t(u,{attrs:{flat:""}},[t(A,{attrs:{active:e.tab==="tasks"}})],1)],1)],1)],1)},O=[],U=_(J,N,O,!1,null,null,null,null);const ve=U.exports;export{ve as default};
